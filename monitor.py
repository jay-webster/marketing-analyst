import os
import asyncio
import agent
import utils
import json
import re
import ast
from types import SimpleNamespace
from datetime import datetime
from dotenv import load_dotenv
from slack_sdk import WebClient
from slack_sdk.errors import SlackApiError
from google.cloud import firestore
from linkedin_tracker import LinkedInTracker

load_dotenv()
REFERENCE_DOMAIN = "navistone.com"
CACHE_COLLECTION = "discovery_cache"

# --- HELPER: DATABASE ---
try:
    project_id = os.getenv("PROJECT_ID")
    db = firestore.Client(project=project_id) if project_id else firestore.Client()
except Exception:
    db = None


# --- HELPER: POST TO SLACK (Rich Block Kit) ---
def post_update_to_slack(company_name, change_summary, deep_dive_url=None):
    token = os.environ.get("SLACK_BOT_TOKEN")
    channel = os.environ.get("SLACK_CHANNEL_ID")
    if not token or not channel:
        return

    client = WebClient(token=token)

    # Slack Block Kit Design
    blocks = [
        {
            "type": "header",
            "text": {
                "type": "plain_text",
                "text": f"üö® Competitor Update: {company_name}",
                "emoji": True,
            },
        },
        {"type": "divider"},
        {"type": "section", "text": {"type": "mrkdwn", "text": f"{change_summary}"}},
    ]

    if deep_dive_url:
        blocks.append(
            {
                "type": "context",
                "elements": [
                    {
                        "type": "mrkdwn",
                        "text": f"üîó <{deep_dive_url}|Visit Website> | üìÖ {datetime.now().strftime('%Y-%m-%d')}",
                    }
                ],
            }
        )

    try:
        client.chat_postMessage(
            channel=channel, blocks=blocks, text=f"Update detected for {company_name}"
        )
        print(f"‚úÖ Posted update for {company_name} to Slack.")
    except SlackApiError as e:
        print(f"‚ùå Slack Error: {e.response['error']}")


# --- HELPER: SEND EMAIL (Rich HTML) ---
def send_update_email(company_name, change_summary, deep_dive_url=None):
    # Retrieve subscribers
    if not db:
        return
    try:
        subscribers = (
            db.collection("subscribers").where("status", "==", "active").stream()
        )
        recipients = [doc.to_dict()["email"] for doc in subscribers]
    except Exception:
        return

    if not recipients:
        return

    # HTML Email Template
    html_content = f"""
    <html>
        <body style="font-family: Arial, sans-serif; color: #333;">
            <div style="max-width: 600px; margin: 0 auto; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
                <div style="background-color: #0044cc; color: white; padding: 20px;">
                    <h2 style="margin: 0;">üö® Competitor Alert: {company_name}</h2>
                </div>
                <div style="padding: 20px;">
                    <p style="font-size: 16px; line-height: 1.5;">
                        <strong>Analyst Note:</strong><br>
                        {change_summary.replace(chr(10), '<br>')}
                    </p>
                    <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
                    <p style="font-size: 12px; color: #777;">
                        Report generated by Marketing Analyst Agent ‚Ä¢ {datetime.now().strftime('%Y-%m-%d')}
                    </p>
                </div>
            </div>
        </body>
    </html>
    """

    for email in recipients:
        utils.send_email(
            subject=f"‚ö†Ô∏è Update: {company_name} Strategy Shift",
            recipient=email,
            body=change_summary,  # Plain text fallback
            attachment_bytes=None,  # No PDF
            filename=None,
            html_body=html_content,  # New HTML support
        )
    print(f"üìß Sent email update for {company_name} to {len(recipients)} subscribers.")


# --- CORE LOGIC: REFRESH (Keep your Bulletproof Version) ---
async def refresh_competitors(target_domain, target_count=5, retry_level=0):
    # ... (Keep the EXACT refresh_competitors function you just fixed.
    #      I am omitting it here to save space, but PASTE IT BACK IN from your previous working version!) ...
    pass
    # [PASTE YOUR WORKING REFRESH FUNCTION HERE]


# --- CORE LOGIC: DISCOVER (Keep Existing) ---
async def discover_competitors(target_domain):
    # ... (Keep existing discover_competitors logic) ...
    pass
    # [PASTE YOUR EXISTING DISCOVER FUNCTION HERE]


# --- CORE LOGIC: SURGICAL REMOVE (Keep Existing) ---
def remove_competitor_from_cache(target_domain, competitor_domain_to_remove):
    # ... (Keep existing logic) ...
    pass
    # [PASTE YOUR EXISTING REMOVE FUNCTION HERE]


# --- ANALYSIS HELPERS ---
async def check_linkedin_updates(company_name, domain):
    print(f"\n--- üïµÔ∏è‚Äç‚ôÇÔ∏è Starting LinkedIn Check for {company_name} ---")
    tracker = LinkedInTracker(agent_module=agent, use_mock=False)
    try:
        return await tracker.get_company_updates(company_name, domain)
    except Exception:
        return None


async def analyze_competitor_website(domain):
    # ... (Keep existing analyze_competitor_website logic) ...
    pass
    # [PASTE YOUR EXISTING ANALYZE FUNCTION HERE]


# --- MAIN JOB: REPORT BY EXCEPTION ---
async def run_daily_brief():
    print(f"üöÄ Starting Daily Surveillance: {datetime.now()}")
    if not db:
        return

    comp_docs = db.collection("competitors").stream()
    competitors = [doc.id for doc in comp_docs]
    memory = utils.load_memory()

    if REFERENCE_DOMAIN in competitors:
        competitors.remove(REFERENCE_DOMAIN)

    updates_detected = 0

    for domain in competitors:
        print(f"--- Surveillance: {domain} ---")
        company_name = domain.split(".")[0].capitalize()

        # 1. Run Analysis
        website_result = await analyze_competitor_website(domain)
        linkedin_result = await check_linkedin_updates(company_name, domain)

        # 2. Compare with Memory
        prev_data = memory.get(domain, {})
        if isinstance(prev_data, str):
            prev_val_prop = prev_data
        else:
            prev_val_prop = prev_data.get("content", {}).get("value_proposition")

        current_val_prop = getattr(website_result, "value_proposition", "N/A")

        # Detect Changes
        website_changed = False
        # Only trigger if previous existed AND current is different AND current is valid
        if prev_val_prop and prev_val_prop != "N/A":
            if (current_val_prop != prev_val_prop) and (
                "Analysis currently unavailable" not in current_val_prop
            ):
                website_changed = True

        li_summary = (
            linkedin_result.summary_text
            if (linkedin_result and len(linkedin_result.summary_text) > 50)
            else ""
        )
        news_found = bool(li_summary and "No recent updates" not in li_summary)

        # 3. Update Memory (Regardless of notification)
        full_company_data = {
            "name": getattr(website_result, "name", domain),
            "content": {
                "value_proposition": current_val_prop,
                "solutions": getattr(website_result, "solutions", "N/A"),
                "industries": getattr(website_result, "industries", "N/A"),
            },
            "linkedin_update": li_summary or "No recent updates.",
            "last_updated": datetime.now().isoformat(),
        }

        if "Analysis currently unavailable" not in current_val_prop:
            memory[domain] = full_company_data

        # 4. REPORT ON EXCEPTION
        if website_changed or news_found:
            print(f"üîî CHANGE DETECTED for {company_name}!")
            updates_detected += 1

            # Generate Specific Summary for this Company
            change_context = ""
            if website_changed:
                change_context += f"*Website Strategy Shift:*\nOld: {prev_val_prop}\nNew: {current_val_prop}\n\n"
            if news_found:
                change_context += f"*News/Social Update:*\n{li_summary}"

            summary_prompt = f"Act as a competitive intelligence analyst. Summarize this update for {company_name} in 2 bullet points. Focus on the strategic implication:\n{change_context}"
            analyst_note = await agent.run_agent_turn(
                summary_prompt, [], headless=False
            )

            # Fire Notifications IMMEDIATELY
            post_update_to_slack(
                company_name, analyst_note, deep_dive_url=f"https://{domain}"
            )
            send_update_email(
                company_name, analyst_note, deep_dive_url=f"https://{domain}"
            )
        else:
            print(f"üí§ No significant changes for {company_name}.")

        await asyncio.sleep(5)

    utils.save_memory(memory)
    print(f"üíæ Surveillance Complete. {updates_detected} updates sent.")


if __name__ == "__main__":
    asyncio.run(run_daily_brief())
